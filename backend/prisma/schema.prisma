generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int        @id @default(autoincrement())
  name           String
  email          String     @unique
  password       String
  phone          String     @unique
  photo          String?
  publicId       String?
  role           Role       @default(USER)
  referralCode   String     @unique
  referredBy     String?
  createdAt      DateTime   @default(now())
  address        Address[]
  carts          Cart[]
  comment        Comment[]
  orders         Order[]
  wallet         RefWallet?
  referredByUser User?      @relation("UserReferrals", fields: [referredBy], references: [referralCode])
  referredUser   User[]     @relation("UserReferrals")

  @@index([referredBy], map: "User_referredBy_fkey")
}

model RefWallet {
  id     Int   @id @default(autoincrement())
  amount Float
  userId Int   @unique
  user   User  @relation(fields: [userId], references: [id])
}

model Product {
  id            Int             @id @default(autoincrement())
  name          String
  description   String?
  stock         Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  category      Category
  weight        Float
  basePrice     Float
  baseOriginalPrice   Float
  barcode       String?         @unique
  variants       Variants[]
  cart          CartItem[]
  comment       Comment[]
  order         OrderItem[]
  photos        ProductPhotos[]
  productStatus ProductStatus @default(NONE)
}

model Variants {
  id Int @id @default(autoincrement())
  variant String?
  size String?
  color String?
  price Float?
  originalPrice Float?
  product Product @relation(fields:[productId], references:[id])
  productId Int
}

model ProductPhotos {
  id        Int     @id @default(autoincrement())
  url       String
  publicId  String?
  productId Int
  product   Product @relation(fields: [productId], references: [id])

  @@index([productId], map: "ProductPhotos_productId_fkey")
}

model Order {
  id             Int         @id @default(autoincrement())
  userId         Int
  totalPrice     Float
  status         OrderStatus @default(PENDING)
  paymentId      Int?        @unique
  addressId      Int?
  courierId      Int?
  trackingNumber String?     @unique
  updatedAt      DateTime    @updatedAt
  createdAt      DateTime    @default(now())
  address        Address?    @relation(fields: [addressId], references: [id])
  courier        Courier?    @relation(fields: [courierId], references: [id])
  payment        Payment?    @relation(fields: [paymentId], references: [id])
  user           User        @relation(fields: [userId], references: [id])
  items          OrderItem[]

  @@index([addressId], map: "Order_addressId_fkey")
  @@index([courierId], map: "Order_courierId_fkey")
  @@index([userId], map: "Order_userId_fkey")
}

model Courier {
  id          Int      @id @default(autoincrement())
  courierName String
  courierLink String
  createdAt   DateTime @default(now())
  order       Order[]
}

model ShippingRate {
  id        Int      @id @default(autoincrement())
  location  String
  baseFee   Float
  perKgFee  Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id         Int     @id @default(autoincrement())
  orderId    Int
  productId  Int
  quantity   Int
  unitPrice  Float
  totalPrice Float
  size       String?
  color      String?
  variant    String?
  order      Order   @relation(fields: [orderId], references: [id])
  product    Product @relation(fields: [productId], references: [id])

  @@index([orderId], map: "OrderItem_orderId_fkey")
  @@index([productId], map: "OrderItem_productId_fkey")
}

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int
  status    CartStatus
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
}

model CartItem {
  id         Int     @id @default(autoincrement())
  cartId     Int
  productId  Int
  size       String?
  color      String?
  variant    String?
  quantity   Int     @default(1)
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)
  cart       Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product    Product @relation(fields: [productId], references: [id])

  @@index([cartId])
  @@index([productId])
}

model Payment {
  id            Int           @id @default(autoincrement())
  status        PaymentStatus
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("BDT")
  transactionId String?       @unique
  rawPayload    Json?
  paymentmethod PaymentMethod
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  order         Order?

  @@index([status])
}

model Address {
  id         Int      @id @default(autoincrement())
  userId     Int?
  label      String?
  name       String
  phone      String
  line1      String
  barangay   String
  city       String?
  postalCode String?
  province   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User?    @relation(fields: [userId], references: [id])
  order      Order[]

  @@index([userId], map: "Address_userId_fkey")
}

model Comment {
  id        Int      @id @default(autoincrement())
  comment   String
  createdAt DateTime @default(now())
  userId    Int
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([productId], map: "Comment_productId_fkey")
  @@index([userId], map: "Comment_userId_fkey")
}

enum Role {
  USER
  ADMIN
}

enum CartStatus {
  PENDING
  COMPLETED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURN
}

enum PaymentStatus {
  PAID
  UNPAID
  CANCELLED
  FAILED
}

enum Category {
  MENSFASHION
  WOMENFASHION
  KIDSFASHION
  ACCESSORIES
  PERFUME
}

enum PaymentMethod {
  COD
  CARD
}

enum ProductStatus {
  NONE
  TOP_SELLING
  MOST_POPULER
  SALES_OFFER
  PROMO_OFFER
}
